---
name: chan-algo-tuning
description: 调整和迭代缠论算法实现（分型/笔/线段/中枢）并与 chan.py 行为对齐。适用于线段断连、方向错误、数量异常、中枢识别不稳定等问题；或当用户要求“更贴合 chan.py”“优化笔线段中枢逻辑”“解释当前算法并修改参数”时使用。
---

# chan-algo-tuning

按以下步骤处理算法需求，保持改动小步、可解释、可回退。

## 1) 先确认问题范围

- 明确用户要改哪一层：`fractal` / `bi` / `segment` / `zhongshu`
- 明确症状类型：
  - 结构错误（断连、跳连、方向反转）
  - 数量异常（过少/过多）
  - 边界行为（最后一段、未确认段）

若用户同时提多个层级，优先顺序：`bi -> segment -> zhongshu`。

## 2) 先读关键文件

- `src/core/chan/bi.ts`
- `src/core/chan/segment.ts`
- `src/core/chan/zhongshu.ts`
- `docs/chan-algorithm-guide.md`

只加载必要上下文，不做无关重构。

## 3) 变更策略

- 仅修改与当前问题直接相关的规则
- 保持数据结构兼容（`types.ts` 除非必须不要改）
- 优先抽取小函数，避免在主循环内堆复杂分支

常用可调参数：

- 线段转折确认跨度（例如 `i - peakBiIndex > 2`）
- 突破判定参考（`i` 对 `i-2`）
- 中枢起点规则（两笔重叠 / 三段重叠）

## 4) 输出要求

- 明确说明“改了什么规则 + 为什么”
- 给出影响范围（笔/线段/中枢各会怎样变化）
- 给出后续可调开关建议（参数化点位）

## 5) 防回归检查（无需单元测试）

至少做以下人工验证：

- 相邻笔是否连续衔接
- 线段是否避免明显断连与反逻辑方向
- 中枢是否仅在有效重叠时出现

若发现与 chan.py 结果差异，先记录“差异类型”，再决定是否升级到特征序列/递归确认方案。

## 参考

- `references/algo-alignment-checklist.md`

